<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Freeway Cards</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <style>
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-card {
            max-width: 450px;
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .auth-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        .success-state {
            text-align: center;
            display: none;
        }
        .success-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 24px;
        }
        .back-link {
            text-align: center;
            margin-top: 24px;
        }
        .resend-section {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        .countdown {
            font-weight: bold;
            color: var(--primary);
        }
        @media (max-width: 768px) {
            .auth-card {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- Request Form -->
            <div id="requestForm">
                <div class="auth-header">
                    <div class="auth-icon">üîë</div>
                    <h1>Reset Password</h1>
                    <p style="color: #666;">Enter your email address and we'll send you a secure link to reset your password.</p>
                </div>
                
                <form id="forgotForm">
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" placeholder="Enter your email address" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 16px;" id="submitBtn">
                        üìß Send Reset Link
                    </button>
                </form>
                
                <div class="back-link">
                    <a href="../login.html" style="color: var(--primary); text-decoration: none;">
                        ‚Üê Back to Login
                    </a>
                </div>
            </div>

            <!-- Success State -->
            <div id="successState" class="success-state">
                <div class="success-icon">‚úÖ</div>
                <h2>Check Your Email</h2>
                <p style="color: #666; margin-bottom: 24px;">
                    We've sent a password reset link to <strong id="sentEmail"></strong>
                </p>
                <p style="font-size: 14px; color: #666; margin-bottom: 32px;">
                    The link will expire in 15 minutes. If you don't see the email, check your spam folder.
                </p>
                
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openEmailClient()">
                        üìß Open Email
                    </button>
                    <button class="btn btn-secondary" onclick="goToLogin()">
                        üîë Back to Login
                    </button>
                </div>
                
                <div class="resend-section" id="resendSection">
                    <p style="margin-bottom: 12px;">Didn't receive the email?</p>
                    <button class="btn btn-secondary" onclick="resendEmail()" id="resendBtn">
                        üì§ Resend Email
                    </button>
                    <div id="resendCooldown" style="display: none; margin-top: 12px; color: #666;">
                        Please wait <span class="countdown" id="countdown">60</span> seconds before resending.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/ui-components.js"></script>
    <script>
        let userEmail = '';
        let resendCooldownTimer = null;

        document.getElementById('forgotForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            if (!email) {
                ui.showToast({
                    type: 'error',
                    title: 'Email Required',
                    message: 'Please enter your email address'
                });
                return;
            }
            
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                ui.showToast({
                    type: 'error',
                    title: 'Invalid Email',
                    message: 'Please enter a valid email address'
                });
                return;
            }
            
            const btn = document.getElementById('submitBtn');
            ui.showLoading(btn, 'üìß Sending...');
            
            try {
                // Simulate API call
                await sendPasswordReset(email);
                
                ui.hideLoading(btn);
                userEmail = email;
                showSuccessState();
                
            } catch (error) {
                ui.hideLoading(btn);
                ui.showToast({
                    type: 'error',
                    title: 'Failed to Send',
                    message: error.message || 'Please try again or contact support'
                });
            }
        });

        async function sendPasswordReset(email) {
            // Simulate API call to backend
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // Demo: simulate different responses based on email
                    if (email.includes('invalid')) {
                        reject(new Error('Email address not found'));
                    } else if (email.includes('blocked')) {
                        reject(new Error('Account is temporarily blocked'));
                    } else {
                        resolve({ success: true });
                    }
                }, 2000);
            });
        }

        function showSuccessState() {
            document.getElementById('requestForm').style.display = 'none';
            document.getElementById('successState').style.display = 'block';
            document.getElementById('sentEmail').textContent = userEmail;
            
            // Show resend option after 30 seconds
            setTimeout(() => {
                document.getElementById('resendSection').style.display = 'block';
            }, 30000);
            
            ui.showToast({
                type: 'success',
                title: 'Email Sent!',
                message: 'Check your inbox for the reset link'
            });
        }

        function openEmailClient() {
            // Try to open default email client
            const emailDomain = userEmail.split('@')[1];
            const emailUrls = {
                'gmail.com': 'https://mail.google.com',
                'outlook.com': 'https://outlook.live.com',
                'hotmail.com': 'https://outlook.live.com',
                'yahoo.com': 'https://mail.yahoo.com',
                'icloud.com': 'https://www.icloud.com/mail'
            };
            
            const url = emailUrls[emailDomain] || 'mailto:';
            window.open(url, '_blank');
        }

        function goToLogin() {
            window.location.href = '../login.html';
        }

        async function resendEmail() {
            const btn = document.getElementById('resendBtn');
            ui.showLoading(btn, 'üì§ Resending...');
            
            try {
                await sendPasswordReset(userEmail);
                ui.hideLoading(btn);
                
                ui.showToast({
                    type: 'success',
                    title: 'Email Resent!',
                    message: 'Check your inbox for the new reset link'
                });
                
                startResendCooldown();
                
            } catch (error) {
                ui.hideLoading(btn);
                ui.showToast({
                    type: 'error',
                    title: 'Failed to Resend',
                    message: 'Please try again later'
                });
            }
        }

        function startResendCooldown() {
            let seconds = 60;
            document.getElementById('resendBtn').style.display = 'none';
            document.getElementById('resendCooldown').style.display = 'block';
            
            resendCooldownTimer = setInterval(() => {
                seconds--;
                document.getElementById('countdown').textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(resendCooldownTimer);
                    document.getElementById('resendBtn').style.display = 'inline-block';
                    document.getElementById('resendCooldown').style.display = 'none';
                }
            }, 1000);
        }
    </script>
</body>
</html>