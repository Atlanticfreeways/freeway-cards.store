<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cards - Freeway Cards</title>
    <link rel="stylesheet" href="../css/main.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="../dashboard/index.html">Freeway Cards</a>
            </div>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-menu" id="nav-menu">
                <a href="../dashboard/index.html">Dashboard</a>
                <a href="index.html" class="active">Cards</a>
                <a href="../wallet/index.html">Wallet</a>
                <a href="../dashboard/profile.html">Profile</a>
                <div class="user-menu">
                    <div class="user-dropdown">
                        <button class="user-button" onclick="toggleUserMenu()">
                            <span id="user-name">User</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div id="user-dropdown-menu" class="dropdown-menu hidden">
                            <a href="../dashboard/profile.html">Profile Settings</a>
                            <a href="../wallet/index.html">Wallet</a>
                            <a href="../support/index.html">Support</a>
                            <hr>
                            <button onclick="logout()" class="logout-btn">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>My Cards</h1>
            <button id="create-card-btn" class="btn btn-primary">Create New Card</button>
        </div>

        <div class="cards-grid" id="cards-grid">
            <!-- Cards will be loaded here -->
        </div>

        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-icon">ðŸ’³</div>
            <h3>No cards yet</h3>
            <p>Create your first virtual card to get started</p>
            <button onclick="openCreateModal()" class="btn btn-primary">Create Card</button>
        </div>
    </div>

    <!-- Create Card Modal -->
    <div id="create-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Card</h3>
                <button onclick="closeCreateModal()">Ã—</button>
            </div>
            <form id="create-card-form">
                <div class="form-group">
                    <label>Card Type</label>
                    <div class="card-type-selector">
                        <label class="radio-card">
                            <input type="radio" name="cardType" value="visa" checked>
                            <div class="card-option">
                                <div class="card-brand">ðŸ’³ Visa</div>
                                <div class="card-desc">Widely accepted worldwide</div>
                            </div>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="cardType" value="mastercard">
                            <div class="card-option">
                                <div class="card-brand">ðŸ’³ Mastercard</div>
                                <div class="card-desc">Global payment network</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Card Name</label>
                    <input type="text" id="card-name" placeholder="e.g., Marketing Expenses" required>
                </div>

                <div class="form-group">
                    <label>Spending Limit</label>
                    <select id="spending-limit">
                        <option value="100">$100</option>
                        <option value="500">$500</option>
                        <option value="1000" selected>$1,000</option>
                        <option value="5000">$5,000</option>
                        <option value="10000">$10,000</option>
                        <option value="custom">Custom Amount</option>
                    </select>
                </div>

                <div class="form-group" id="custom-limit" style="display: none;">
                    <label>Custom Limit ($)</label>
                    <input type="number" id="custom-amount" min="1" max="100000">
                </div>

                <button type="submit" class="btn btn-primary">Create Card</button>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/ui-components.js"></script>
    <script>
        // Card Management System - Updated for Freewaycards-store
        class CardManager {
            constructor() {
                this.cards = JSON.parse(localStorage.getItem('userCards') || '[]');
                this.currentUser = JSON.parse(localStorage.getItem('currentUser'));
                this.checkAuth();
                this.initializeEventListeners();
                this.loadCards();
            }

            checkAuth() {
                if (!this.currentUser) {
                    window.location.href = '../login.html';
                    return;
                }
                document.getElementById('user-name').textContent = this.currentUser.name;
            }

            initializeEventListeners() {
                document.getElementById('create-card-btn').addEventListener('click', () => this.openCreateModal());
                document.getElementById('create-card-form').addEventListener('submit', (e) => this.createCard(e));
                document.getElementById('spending-limit').addEventListener('change', (e) => this.toggleCustomLimit(e));
            }

            openCreateModal() {
                document.getElementById('create-modal').classList.remove('hidden');
            }

            closeCreateModal() {
                document.getElementById('create-modal').classList.add('hidden');
                document.getElementById('create-card-form').reset();
                document.getElementById('custom-limit').style.display = 'none';
            }

            toggleCustomLimit(e) {
                const customDiv = document.getElementById('custom-limit');
                customDiv.style.display = e.target.value === 'custom' ? 'block' : 'none';
            }

            generateCardNumber(type) {
                const prefixes = {
                    visa: '4',
                    mastercard: '5'
                };
                
                let cardNumber = prefixes[type];
                for (let i = 1; i < 16; i++) {
                    cardNumber += Math.floor(Math.random() * 10);
                }
                return cardNumber;
            }

            generateCVV() {
                return Math.floor(100 + Math.random() * 900).toString();
            }

            generateExpiryDate() {
                const now = new Date();
                const expiry = new Date(now.getFullYear() + 3, now.getMonth());
                return `${(expiry.getMonth() + 1).toString().padStart(2, '0')}/${expiry.getFullYear().toString().slice(-2)}`;
            }

            createCard(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const cardType = formData.get('cardType');
                const cardName = document.getElementById('card-name').value;
                const spendingLimit = document.getElementById('spending-limit').value;
                const customAmount = document.getElementById('custom-amount').value;
                
                const limit = spendingLimit === 'custom' ? parseFloat(customAmount) : parseFloat(spendingLimit);
                
                const newCard = {
                    id: Date.now().toString(),
                    userId: this.currentUser.email,
                    name: cardName,
                    type: cardType,
                    number: this.generateCardNumber(cardType),
                    cvv: this.generateCVV(),
                    expiry: this.generateExpiryDate(),
                    balance: 0,
                    spendingLimit: limit,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    transactions: []
                };

                this.cards.push(newCard);
                localStorage.setItem('userCards', JSON.stringify(this.cards));
                
                this.loadCards();
                this.closeCreateModal();
                this.showSuccess('Card created successfully!');
            }

            loadCards() {
                const userCards = this.cards.filter(card => card.userId === this.currentUser.email);
                const cardsGrid = document.getElementById('cards-grid');
                const emptyState = document.getElementById('empty-state');

                if (userCards.length === 0) {
                    cardsGrid.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                cardsGrid.style.display = 'grid';
                emptyState.style.display = 'none';

                cardsGrid.innerHTML = userCards.map(card => this.createCardHTML(card)).join('');
            }

            createCardHTML(card) {
                const maskedNumber = this.maskCardNumber(card.number);
                const statusClass = card.status === 'active' ? 'active' : 'frozen';
                const brandClass = card.type === 'visa' ? 'visa' : 'mastercard';

                return `
                    <div class="card-item ${brandClass}" data-card-id="${card.id}">
                        <div class="card-visual">
                            <div class="card-brand">${card.type.toUpperCase()}</div>
                            <div class="card-number">${maskedNumber}</div>
                            <div class="card-details">
                                <div class="card-expiry">${card.expiry}</div>
                                <div class="card-cvv">â€¢â€¢â€¢</div>
                            </div>
                            <div class="card-name">${card.name}</div>
                        </div>
                        <div class="card-info">
                            <div class="card-balance">$${card.balance.toFixed(2)} / $${card.spendingLimit.toLocaleString()}</div>
                            <div class="card-status ${statusClass}">${card.status}</div>
                        </div>
                        <div class="card-actions">
                            <button onclick="cardManager.viewCard('${card.id}')" class="btn-small">View</button>
                            <button onclick="cardManager.toggleCard('${card.id}')" class="btn-small ${card.status === 'active' ? 'warning' : 'success'}">
                                ${card.status === 'active' ? 'Freeze' : 'Unfreeze'}
                            </button>
                            <button onclick="cardManager.deleteCard('${card.id}')" class="btn-small danger">Delete</button>
                        </div>
                    </div>
                `;
            }

            maskCardNumber(number) {
                return number.replace(/(\d{4})(\d{4})(\d{4})(\d{4})/, '$1 â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ $4');
            }

            viewCard(cardId) {
                window.location.href = `details.html?id=${cardId}`;
            }

            toggleCard(cardId) {
                const card = this.cards.find(c => c.id === cardId);
                if (!card) return;

                card.status = card.status === 'active' ? 'frozen' : 'active';
                localStorage.setItem('userCards', JSON.stringify(this.cards));
                
                this.loadCards();
                this.showSuccess(`Card ${card.status === 'active' ? 'unfrozen' : 'frozen'} successfully!`);
            }

            deleteCard(cardId) {
                if (!confirm('Are you sure you want to delete this card? This action cannot be undone.')) {
                    return;
                }

                this.cards = this.cards.filter(c => c.id !== cardId);
                localStorage.setItem('userCards', JSON.stringify(this.cards));
                
                this.loadCards();
                this.showSuccess('Card deleted successfully!');
            }

            showSuccess(message) {
                const toast = document.createElement('div');
                toast.className = 'toast success';
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #059669;
                    color: white;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    z-index: 10000;
                `;
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

        // Global functions
        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            window.location.href = '../index.html';
        }

        function toggleMobileMenu() {
            const navMenu = document.getElementById('nav-menu');
            const toggle = document.querySelector('.mobile-menu-toggle');
            navMenu.classList.toggle('mobile-active');
            toggle.classList.toggle('active');
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown-menu');
            dropdown.classList.toggle('hidden');
        }

        function openCreateModal() {
            cardManager.openCreateModal();
        }

        function closeCreateModal() {
            cardManager.closeCreateModal();
        }

        // Initialize
        const cardManager = new CardManager();
    </script>
</body>
</html>